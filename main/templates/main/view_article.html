{% extends 'base.html' %} {% block content %}
{% load static %}
{% load crispy_forms_tags %}

<!-- Article Display -->

<div class="container">
    <img src="{% static 'images/placeholder.jpeg' %}" class="img-fluid" alt="...">
</div>
  <div class="container">
      <div class="row">
              <h1 class="post-title text-center">{{ article.title }}</h1>
      </div>
      <div class="row">
            <p class="text-center pt-3"><a class="author" href="{% url 'view_profile' article.article_author%}">{{article.article_author}}</a> | {{ article.created_on |date:"F d, Y" }}</p>
    </div>
  </div>
<div class="container">
  <div class="row">
      <div class="col card mb-4  mt-3 left top">
          <div class="card-body">
              <p class="card-text">
                  {{ article.content | safe }}
              </p>
          </div>
      </div>
  </div>
</div>

<!-- Comments Section -->

<div class="container">
    <div class="row">
        <div class="col-lg-8">
            {% for comment in comments %}
            <div class="d-flex flex-column mb-4 p-3 comment-container {% if not comment.approved and comment.comment_author == user %}text-muted{% elif not comment.approved %}d-none{% endif %}">
                <div class="d-flex justify-content-between">
                        <p class="author"><a class="author" href="{% url 'view_profile' comment.comment_author%}">@{{ comment.comment_author }}</a></p>
                    <div class="ml-auto">
                      {% if comment.approved %}
                        <!-- Comment Likes -->
                        {% if user.is_authenticated %}
                        <button class="likes" data-commentid="{{ comment.id }}" data-likescount="{{ comment.comment_likes_count }}">
                            <i class="fa-sharp fa-solid fa-heart m-2 {% if request.user.is_authenticated and request.user in comment.comment_likes.all %}liked{% endif %}"></i>
                            <span class="comment-likes-count">{{ comment.comment_likes_count }}</span>
                        </button>
                        {% else %}
                        <button class="likes" data-toggle="popover" title="Please sign up or log in to like comments." data-trigger="click">
                          <i class="fa-sharp fa-solid fa-heart m-2"></i>
                          <span class="comment-likes-count">{{ comment.comment_likes_count }}</span>
                      </button>
                        {% endif %}
                        {% endif %}
                  </div>
                </div>
                <div>
                    <p><small class="text-muted">{{ comment.created_on }}</small></p>
                </div>
                <div>
                    <p id="comment{{ comment.id }}">{{ comment.body | safe }}</p>
                </div>
                {% if not comment.approved and comment.comment_author == user %}
                <p class="approval">
                    This comment is awaiting approval
                </p>
                {% endif %}
                <div class="d-flex">
                  {% if user.is_authenticated %}
                      {% if comment.comment_author == user %}
                          <button class="btn edit-btn me-2" data-slug="{{ article.article_slug }}" comment_id="{{ comment.id }}" data-bs-toggle="collapse" data-bs-target="#collapseExample">Edit</button>
                          <button type="button" class="btn delete-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" data-slug="{{ article.article_slug }}" comment_id="{{ comment.id }}">Delete</button>
                      {% elif user.is_superuser %}
                          <button type="button" class="btn delete-btn" data-bs-toggle="modal" data-bs-target="#deleteModal" data-slug="{{ article.article_slug }}" comment_id="{{ comment.id }}">Delete</button>
                      {% endif %}
                  {% endif %}
              </div>
            </div>
            {% endfor %}
        </div>

        <!-- Submit a comment -->
        <div class="col-lg-4">
            <p>
                <button class="btn main-btn" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
                  Leave a comment
                </button>
              </p>
              <div class="collapse" id="collapseExample">
                <div class="card card-body m-2">
                        {% if user.is_authenticated %}
                        <h2>Leave a comment:</h2>
                        <p>Posting as: {{ user.username }}</p>
                        <form id="commentForm" method="post">
                            {{ comment_form | crispy }}
                            {% csrf_token %}
                            <button id="submitButton" type="submit"
                              class="btn main-btn">Submit</button>
                          </form>
                          {% else %}
                          <p>If you wish to leave a comment, please
                            <a href="{% url 'account_login' %}" class="log-in-link">log in</a> or
                            <a href="{% url 'register' %}" class="register-link">sign up</a>
                          </p>
                          {% endif %}
                </div>
              </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="deleteModalLabel">Delete comment</h3>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>This action cannot be undone and will permanently delete your comment.</p>
          <p>Are you sure?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
        </div>
      </div>
    </div>
  </div>

{% if user.is_authenticated %}
<script>
$(document).on('click', '.likes', function (e) {
    e.preventDefault();
    var $button = $(this);
    var commentId = $button.data('commentid');
    var likesCount = parseInt($button.data('likescount'));

    $.ajax({
        type: 'POST',
        url: '{% url "like_comment" %}',
        data: {
            commentid: commentId,
            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
            action: 'post'
        },
        success: function (json) {
            $button.find('.comment-likes-count').text(json['result']);
            $button.data('likescount', json['result']);
            $button.find('.fa-heart').toggleClass('liked', json['result'] > likesCount);
        },
        error: function (xhr, errmsg, err) {
            alert('Failed to like the comment. Please try again later.');
        }
    });
});
</script>
{% endif %}
{% block extras %}
<script src="{% static 'js/comments.js' %}"></script>
{% endblock %}
{% endblock content %}